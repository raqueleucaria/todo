<div id="<%= dom_id task %>" class="bg-white rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow duration-200 <%= 'opacity-75' if task.completed? %>">
  
  <div class="p-4">
    <div class="flex items-center justify-between group">
      <div class="flex items-center flex-grow">
        <%= form_with(model: task, class: "flex items-center") do |form| %>
          <%= form.check_box :completed,
                             data: { id: task.id, action: "tasks#toggle" },
                             class: "mr-4 h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 focus:ring-2 transition-colors" %>
        <% end %>
        
        <div data-controller="inline-edit" 
             data-inline-edit-task-id-value="<%= task.id %>"
             class="flex-grow">
          <span data-inline-edit-target="text"
                data-action="click->inline-edit#startEdit"
                class="text-lg <%= 'line-through text-gray-500' if task.completed? %> <%= 'text-gray-800 font-medium' unless task.completed? %> transition-colors cursor-pointer hover:bg-gray-100 px-2 py-1 rounded">
            <%= task.description %>
          </span>
          
          <input data-inline-edit-target="input"
                 data-action="keydown->inline-edit#handleKeydown blur->inline-edit#handleBlur"
                 type="text"
                 class="hidden text-lg px-2 py-1 border border-blue-500 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white"
                 placeholder="Digite o nome da tarefa...">
        </div>
        
        <% if task.subtasks.any? %>
          <span class="ml-3 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
            <%= task.subtasks.count %> subtarefa<%= 's' if task.subtasks.count != 1 %>
          </span>
        <% end %>
      </div>
      
      <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
        <%= button_to task_path(task), 
            method: :delete, 
            class: "p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors duration-200",
            title: "Remover tarefa",
            data: { confirm: "Tem certeza que deseja remover esta tarefa?" + (task.subtasks.any? ? " Todas as subtarefas também serão removidas." : "") } do %>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
          </svg>
        <% end %>
      </div>
    </div>

    <% if task.parent_id.nil? %>
      <div class="mt-4 pl-9">
        <div id="<%= dom_id(task, :subtasks) %>" class="space-y-2">
          <% task.subtasks.each do |subtask| %>
            <div id="<%= dom_id subtask %>" class="flex items-center justify-between group/subtask py-2 px-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
              <div class="flex items-center flex-grow">
                <%= form_with(model: subtask, class: "flex items-center") do |form| %>
                  <%= form.check_box :completed,
                                     data: { id: subtask.id, action: "tasks#toggle" },
                                     class: "mr-3 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 focus:ring-2 transition-colors" %>
                <% end %>
                
                <div data-controller="inline-edit" 
                     data-inline-edit-task-id-value="<%= subtask.id %>"
                     class="flex-grow">
                  <span data-inline-edit-target="text"
                        data-action="click->inline-edit#startEdit"
                        class="text-sm <%= 'line-through text-gray-500' if subtask.completed? %> <%= 'text-gray-700' unless subtask.completed? %> transition-colors cursor-pointer hover:bg-gray-200 px-2 py-1 rounded">
                    <%= subtask.description %>
                  </span>
                  
                  <input data-inline-edit-target="input"
                         data-action="keydown->inline-edit#handleKeydown blur->inline-edit#handleBlur"
                         type="text"
                         class="hidden text-sm px-2 py-1 border border-blue-500 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white w-full"
                         placeholder="Digite o nome da subtarefa...">
                </div>
              </div>
              
              <div class="flex items-center gap-1 opacity-0 group-hover/subtask:opacity-100 transition-opacity duration-200">
                <%= button_to task_path(subtask), 
                    method: :delete, 
                    class: "p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors duration-200",
                    title: "Remover subtarefa",
                    data: { confirm: "Tem certeza que deseja remover esta subtarefa?" } do %>
                  <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>

        <div class="mt-3" data-controller="subtask-form">
          <button type="button" 
                  data-action="click->subtask-form#toggle"
                  class="flex items-center text-sm text-gray-500 hover:text-blue-600 transition-colors duration-200">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            Adicionar subtarefa
          </button>
          
          <div data-subtask-form-target="form" class="hidden mt-2">
            <%= form_with(model: Task.new, url: tasks_path, class: "flex items-center gap-2") do |form| %>
              <%= form.hidden_field :parent_id, value: task.id %>
              <%= form.text_field :description, 
                  placeholder: "Digite a subtarefa...", 
                  class: "flex-grow text-sm px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors",
                  data: { subtask_form_target: "input" } %>
              <%= form.submit "Adicionar", 
                  class: "px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors cursor-pointer" %>
              <button type="button" 
                      data-action="click->subtask-form#cancel"
                      class="px-3 py-2 text-gray-500 text-sm hover:text-gray-700 transition-colors">
                Cancelar
              </button>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>
